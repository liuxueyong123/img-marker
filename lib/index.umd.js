!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ImgMarker={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.
    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.
    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},e(t,i)};var i,s,a=function(){return a=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},a.apply(this,arguments)};t.ShapeType=void 0,(i=t.ShapeType||(t.ShapeType={}))[i.rect=1]="rect",t.MarkMode=void 0,(s=t.MarkMode||(t.MarkMode={}))[s.edit=0]="edit",s[s.rect=1]="rect";var n=function(){var t;return null===(t=window.navigator)||void 0===t?void 0:t.userAgent.includes("Mobile")},o=function(i){function s(e,s){var a=i.call(this,e,s)||this;return a.type=t.ShapeType.rect,a.type=t.ShapeType.rect,a}return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}(s,i),Object.defineProperty(s.prototype,"ctrlsData",{get:function(){var t=this.coor,e=t[0],i=e[0],s=e[1],a=t[1],n=a[0],o=a[1];return[[i,s],[i+(n-i)/2,s],[n,s],[n,s+(o-s)/2],[n,o],[i+(n-i)/2,o],[i,o],[i,s+(o-s)/2]]},enumerable:!1,configurable:!0}),s.MIN_WIDTH=10,s.MIN_HEIGHT=10,s}((function(e,i){this.coor=[],this.strokeStyle="#FFE729",this.fillStyle="rgba(255,231,41, 0.2)",this.lineWidth=4,this.type=t.ShapeType.rect,this.active=!1,this.creating=!1,this.dragging=!1,this.uuid=function(){if("object"==typeof crypto&&"function"==typeof crypto.randomUUID)return crypto.randomUUID();var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var i=16*Math.random();return i=(t+i)%16|0,t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)}))}(),this.index=i,Object.assign(this,e)})),h=function(){function e(e,i){this.CANVAS_WIDTH=0,this.CANVAS_HEIGHT=0,this.IMAGE_ORIGIN_WIDTH=0,this.IMAGE_ORIGIN_HEIGHT=0,this.IMAGE_WIDTH=0,this.IMAGE_HEIGHT=0,this.strokeStyle="#FFE729",this.fillStyle="rgba(255,231,41, 0.2)",this.lineWidth=4,this.activeStrokeStyle="#FFE729",this.activeFillStyle="rgba(255,231,41, 0.2)",this.ctrlStrokeStyle="#505E72",this.ctrlFillStyle="#fff",this.ctrlRadius=4,this.dataset=[],this.image=new Image,this.currentMode=t.MarkMode.edit,this.ctrlIndex=-1,this.currentMousePoint=[0,0],this.handleLoad=this.handleLoad.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handelMouseMove=this.handelMouseMove.bind(this),this.handelMouseUp=this.handelMouseUp.bind(this),this.handelKeyup=this.handelKeyup.bind(this);var s="string"==typeof e?document.querySelector(e):e;s instanceof HTMLCanvasElement?(this.canvas=s,this.initSetting(),this.initEvents(),i&&this.setImage(i)):console.warn("HTMLCanvasElement is required!")}return Object.defineProperty(e.prototype,"activeShape",{get:function(){var t;return null!==(t=this.dataset.find((function(t){return t.active})))&&void 0!==t?t:null},enumerable:!1,configurable:!0}),e.prototype.initSetting=function(){this.ctx=this.ctx||this.canvas.getContext("2d",{alpha:!0}),this.CANVAS_WIDTH=this.canvas.clientWidth,this.CANVAS_HEIGHT=this.canvas.clientHeight,this.canvas.width=1*this.CANVAS_WIDTH,this.canvas.height=1*this.CANVAS_HEIGHT,this.canvas.style.width=this.CANVAS_WIDTH+"px",this.canvas.style.height=this.CANVAS_HEIGHT+"px",this.ctx.scale(1,1)},e.prototype.initEvents=function(){this.image.addEventListener("load",this.handleLoad),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handelMouseMove),this.canvas.addEventListener("mouseup",this.handelMouseUp),document.body.addEventListener("keyup",this.handelKeyup)},e.prototype.destroy=function(){this.image.removeEventListener("load",this.handleLoad),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handelMouseMove),this.canvas.removeEventListener("mouseup",this.handelMouseUp),document.body.removeEventListener("keyup",this.handelKeyup)},e.prototype.handleLoad=function(){this.IMAGE_ORIGIN_WIDTH=this.IMAGE_WIDTH=this.image.width,this.IMAGE_ORIGIN_HEIGHT=this.IMAGE_HEIGHT=this.image.height,this.fitZoom(),this.update()},e.prototype.handleMouseDown=function(e){var i,s,a=this;e.stopPropagation();var h=this.mergeEvent(e),r=h.mouseX,c=h.mouseY,p=h.mouseCX,u=h.mouseCY,d=n()&&2===e.touches.length?[p,u]:[r,c];if(!n()&&1===e.buttons||n()&&1===e.touches.length){this.currentMousePoint=d;var l=null!==(s=null===(i=this.activeShape)||void 0===i?void 0:i.ctrlsData)&&void 0!==s?s:[];if(this.ctrlIndex=l.findIndex((function(t){return a.isPointInCircle(d,t,a.ctrlRadius)})),this.ctrlIndex>-1)return void this.changeCursor("nwse-resize");if(this.currentMode>t.MarkMode.edit){var v=void 0,f=[r,c];this.currentMode,t.MarkMode.rect,(v=new o({coor:[f,f]},this.dataset.length)).creating=!0,this.dataset.forEach((function(t){t.active=!1})),v.active=!0,this.dataset.push(v)}else{var y=this.isHitOnShape(d),I=y.isOnShape,S=y.index,g=y.shape;I?(this.changeCursor("move"),this.dataset.map((function(t,e){return t.active=e===S})),g.dragging=!0,this.dataset.splice(S,1),this.dataset.push(g)):(this.activeShape&&(this.activeShape.active=!1),this.dataset.sort((function(t,e){return t.index-e.index})))}this.update()}},e.prototype.handelMouseMove=function(e){var i;e.stopPropagation();var s=this.mergeEvent(e),a=s.mouseX,h=s.mouseY,r=s.mouseCX,c=s.mouseCY,p=n()&&2===e.touches.length?[r,c]:[a,h],u=this.isHitOnShape(p),d=u.isOnShape,l=u.shape;if(this.ctrlIndex>-1?this.changeCursor("nwse-resize"):this.currentMode>t.MarkMode.edit?this.changeCursor("copy"):d?this.changeCursor(l.active?"move":"pointer"):this.changeCursor("default"),(!n()&&1===e.buttons||n()&&1===e.touches.length)&&(null===(i=this.activeShape)||void 0===i?void 0:i.type)){if(this.ctrlIndex>-1){if(this.activeShape.type===t.ShapeType.rect){var v=this.activeShape.coor,f=v[0],y=f[0],I=f[1],S=v[1],g=S[0],M=S[1],x=[];switch(this.ctrlIndex){case 0:x=[[a,h],[g,M]];break;case 1:x=[[y,h],[g,M]];break;case 2:x=[[y,h],[a,M]];break;case 3:x=[[y,I],[a,M]];break;case 4:x=[[y,I],[a,h]];break;case 5:x=[[y,I],[g,h]];break;case 6:x=[[a,I],[g,h]];break;case 7:x=[[a,I],[g,M]]}var H=x[0],m=H[0],A=H[1],E=x[1],T=E[0],_=E[1];T-m>=o.MIN_WIDTH&&_-A>=o.MIN_HEIGHT&&(this.activeShape.coor=[[m,A],[T,_]])}}else if(this.activeShape.dragging){x=[];for(var C=!0,G=0;G<this.activeShape.coor.length;G++){var b=this.activeShape.coor[G],w=b[0],D=b[1],k=w+a-this.currentMousePoint[0],N=D+h-this.currentMousePoint[1];(k<0||k>this.CANVAS_WIDTH||N<0||N>this.CANVAS_HEIGHT)&&(C=!1),x.push([k,N])}C&&(this.activeShape.coor=x)}else this.activeShape.creating&&(this.changeCursor("nwse-resize"),this.activeShape.type===t.ShapeType.rect&&this.activeShape.coor.splice(1,1,[a,h]));this.currentMousePoint=p,this.update()}},e.prototype.handelMouseUp=function(e){var i;if(e.stopPropagation(),this.ctrlIndex=-1,(null===(i=this.activeShape)||void 0===i?void 0:i.type)&&(this.activeShape.dragging=!1,this.activeShape.creating)){if(this.activeShape.type===t.ShapeType.rect){var s=this.activeShape.coor,a=s[0],n=a[0],h=a[1],r=s[1],c=r[0],p=r[1];Math.abs(n-c)<o.MIN_WIDTH||Math.abs(h-p)<o.MIN_HEIGHT?this.dataset.pop():(this.activeShape.coor=[[Math.min(n,c),Math.min(h,p)],[Math.max(n,c),Math.max(h,p)]],this.activeShape.creating=!1)}this.update()}},e.prototype.handelKeyup=function(t){var e;t.stopPropagation(),(null===(e=this.activeShape)||void 0===e?void 0:e.type)&&("Backspace"!==t.key&&"Escape"!==t.key||this.deleteByIndex(this.activeShape.index))},e.prototype.fitZoom=function(){var t=this.CANVAS_WIDTH/this.CANVAS_HEIGHT,e=this.IMAGE_ORIGIN_WIDTH/this.IMAGE_ORIGIN_HEIGHT;t>e?(this.IMAGE_HEIGHT=this.CANVAS_HEIGHT,this.IMAGE_WIDTH=this.CANVAS_HEIGHT*e):(this.IMAGE_WIDTH=this.CANVAS_WIDTH,this.IMAGE_HEIGHT=this.CANVAS_WIDTH/e)},e.prototype.setData=function(e){this.dataset=e.map((function(e,i){return e.type,t.ShapeType.rect,new o(e,i)})),this.update()},e.prototype.setMode=function(t){this.currentMode=t},e.prototype.deleteByIndex=function(t){var e=this.dataset.findIndex((function(e){return e.index===t}));e>-1&&(this.dataset.splice(e,1),this.dataset.forEach((function(t,e){t.index=e})),this.update())},e.prototype.update=function(){this.ctx.save(),this.ctx.clearRect(0,0,this.CANVAS_WIDTH,this.CANVAS_HEIGHT),this.drawShapes(),this.activeShape&&[t.ShapeType.rect].includes(this.activeShape.type)&&this.drawCtrlList(this.activeShape),this.ctx.restore()},e.prototype.drawShapes=function(){for(var e=0;e<this.dataset.length;e++){var i=this.dataset[e];if(i.type===t.ShapeType.rect)this.drawRect(i)}},e.prototype.drawImg=function(){var t=(this.CANVAS_WIDTH-this.IMAGE_WIDTH)/2,e=(this.CANVAS_HEIGHT-this.IMAGE_HEIGHT)/2;this.ctx.drawImage(this.image,t,e,this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},e.prototype.drawRect=function(t){if(2===t.coor.length){var e=t.strokeStyle,i=t.fillStyle,s=t.active,a=t.creating,n=t.coor,o=t.lineWidth,h=n[0],r=h[0],c=h[1],p=n[1],u=p[0],d=p[1];this.ctx.save(),this.ctx.lineWidth=o||this.lineWidth,this.ctx.fillStyle=i||this.fillStyle,this.ctx.strokeStyle=s||a?this.activeStrokeStyle:e||this.strokeStyle;var l=u-r,v=d-c;this.ctx.fillRect(r,c,l,v),this.ctx.strokeRect(r,c,l,v),this.ctx.restore()}},e.prototype.drawCtrlList=function(t){var e=this;t.ctrlsData.forEach((function(t,i){e.drawCtrl(t)}))},e.prototype.drawCtrl=function(t){var e=t[0],i=t[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(e,i,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(e,i,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},e.prototype.setImage=function(t){this.image.src=t,this.image.crossOrigin="anonymous",this.canvas.style.backgroundImage='url("'.concat(t,'")'),this.canvas.style.backgroundSize="contain",this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundPosition="center center"},e.prototype.exportImg=function(t,e){return void 0===t&&(t="image/png"),void 0===e&&(e=1),this.ctx.save(),this.ctx.clearRect(0,0,this.CANVAS_WIDTH,this.CANVAS_HEIGHT),this.ctx.fillStyle="#fff",this.ctx.fillRect(0,0,this.CANVAS_WIDTH,this.CANVAS_HEIGHT),this.drawImg(),this.drawShapes(),this.ctx.restore(),this.canvas.toDataURL(t,e)},e.prototype.mergeEvent=function(t){var e=0,i=0,s=0,o=0;if(n()){var h=t.touches[0],r=h.clientX,c=h.clientY,p=t.target.getBoundingClientRect(),u=p.left,d=p.top;if(e=Math.round(r-u),i=Math.round(c-d),2===t.touches.length){var l=t.touches[1]||{},v=l.clientX,f=void 0===v?0:v,y=l.clientY,I=void 0===y?0:y;s=Math.round(Math.abs((f-r)/2+r)-u),o=Math.round(Math.abs((I-c)/2+c)-d)}}else e=t.offsetX,i=t.offsetY;return a(a({},t),{mouseX:e,mouseY:i,mouseCX:s,mouseCY:o})},e.prototype.isPointInCircle=function(t,e,i){var s=t[0],a=t[1],n=e[0],o=e[1];return Math.sqrt(Math.pow(n-s,2)+Math.pow(o-a,2))<=i},e.prototype.isPointInRect=function(t,e){var i=t[0],s=t[1],a=e[0],n=a[0],o=a[1],h=e[1],r=h[0],c=h[1];return n<=i&&i<=r&&o<=s&&s<=c},e.prototype.isHitOnShape=function(e){for(var i=this.dataset.length-1;i>=0;i--){var s=this.dataset[i];if(s.type===t.ShapeType.rect&&this.isPointInRect(e,s.coor))return{isOnShape:!0,index:i,shape:s}}return{isOnShape:!1,index:-1,shape:null}},e.prototype.changeCursor=function(t){this.canvas.style.cursor=t},e}();t.default=h,Object.defineProperty(t,"__esModule",{value:!0})}));
